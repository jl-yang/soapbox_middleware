<html>
    <head>
		
		<script src="../js/sockjs.js"></script>
		<script src="../js/stomp.js"></script>		
		<script src="../js/adapter.js"></script>
		<script src="../js/MediaStreamRecorder.js"></script>
        <script src="../js/RecordRTC.js"></script>
        <script src="../js/middleware_api.js"></script>
		<title>RTCPeerConnection</title>

	</head>	
    <body>
        <div id="container">
            <video id="localVideo" autoplay></video>         			
        </div>
		<div>
            <input type="button" id="stop_btn" value="Stop recording"></input>
        </div>
		<script>  
            
			var localVideo = document.getElementById('localVideo');
			var self = this;
			var localStream;
			var soapbox;
			var stomp;
			
			console.log('Requesting local stream');
			navigator.getUserMedia(
				{
					video: true,
					audio: true
				}, 
				gotStream, 
				function (error) {
					console.log('navigator.getUserMedia error: ', error);
				}
			);
			function gotStream(stream) {   
				console.log('Received local stream');
				localStream = stream;
				self.localVideo.src = URL.createObjectURL(stream); 
                soapbox = new Soapbox();
				stomp = soapbox.connect(function () {
					soapbox.submit({"name": "Jilin"});
					soapbox.start(stream);
                    
                    soapbox.onreceivelikes = function (likes) {
                        console.log("I got likes update:" + likes);
                    };
                    
                    soapbox.register();
                    
                    var recordRTC = RecordRTC(stream, {
                        type: 'video'
                    });
                    
                    window.recordRTC = recordRTC;
                    
                    recordRTC.startRecording();                    
                    
                    var stop_btn = document.getElementById("stop_btn");
                    stop_btn.onclick = function() {
                        recordRTC.stopRecording(function (url) {
                            console.log(url);
                            
                            var blob = recordRTC.getBlob();
                            recordRTC.getDataURL(function(dataURL) {
                                console.log(dataURL);
                            });
                        });
                    }
                    
					//soapbox.record(self.localVideo, localStream);
					
				});	
                     
		
            //Try to tell signaling server that it is about to close
            window.onbeforeunload = function(event) {
                soapbox.stop();
            };
            
				
			}
			
		</script>
		
    </body>
</html>
